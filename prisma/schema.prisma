// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String    @id @default(uuid())
  username               String    @unique @db.VarChar(255)
  passwordHash           String    @map("password_hash") @db.Text
  encryptedUsername      String?   @map("encrypted_username") @db.Text
  encryptedPasswordHash  String?   @map("encrypted_password_hash") @db.Text
  publicKey              String?   @map("public_key") @db.Text
  createdAt              DateTime  @default(now()) @map("created_at")

  files                  File[]

  sentMessages           Message[] @relation("SentMessages")
  receivedMessages       Message[] @relation("ReceivedMessages")

  @@map("users")
}

model File {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  filename   String   @db.Text
  url        String   @db.Text
  uploadedAt DateTime @default(now()) @map("uploaded_at")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("files")
}

model Message {
  id            String   @id @default(uuid())
  senderId      String   @map("sender_id")
  recipientId   String   @map("recipient_id")
  ciphertext    String   @db.Text                // AES-GCM ciphertext (base64 or b64 of iv+cipher)
  encryptedKey  String   @map("encrypted_key") @db.Text // AES key encrypted with recipient's RSA public key (base64)
  createdAt     DateTime @default(now()) @map("created_at")

  sender        User     @relation("SentMessages", fields: [senderId], references: [id])
  recipient     User     @relation("ReceivedMessages", fields: [recipientId], references: [id])

  @@map("messages")
}

